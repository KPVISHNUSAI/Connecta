global
    log stdout format raw local0
    maxconn 4096
    user haproxy
    group haproxy
    daemon

    # SSL
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  http-server-close
    option  forwardfor except 127.0.0.0/8
    option  redispatch
    retries 3
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http

# Stats Page
frontend stats
    bind *:9000
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# Main Frontend
frontend main
    bind *:80
    bind *:443 ssl crt /usr/local/etc/haproxy/certs/

    # ACLs
    acl is_api path_beg /api/
    acl is_admin path_beg /admin/
    acl is_static path_beg /static/ /media/
    
    # Rate Limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }

    # Routing
    use_backend api_backend if is_api
    use_backend admin_backend if is_admin
    use_backend static_backend if is_static
    default_backend api_backend

# API Backend
backend api_backend
    balance leastconn
    option httpchk GET /api/health/
    http-check expect status 200
    
    server backend1 backend1:8000 check inter 2000 rise 2 fall 3 maxconn 500
    server backend2 backend2:8000 check inter 2000 rise 2 fall 3 maxconn 500
    server backend3 backend3:8000 check inter 2000 rise 2 fall 3 maxconn 500
    server backend4 backend4:8000 check inter 2000 rise 2 fall 3 maxconn 500
    server backend5 backend5:8000 check inter 2000 rise 2 fall 3 maxconn 500

# Admin Backend (sticky sessions)
backend admin_backend
    balance source
    cookie SERVERID insert indirect nocache
    
    server backend1 backend1:8000 check cookie backend1
    server backend2 backend2:8000 check cookie backend2

# Static Files Backend
backend static_backend
    balance roundrobin
    server nginx nginx:80 check